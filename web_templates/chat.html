{% extends "base.html" %}

{% block title %}Chat - Multi-Agent System{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5>üí¨ Chat Sessions</h5>
            </div>
            <div class="card-body">
                <!-- Connection Status -->
                <div class="mb-3">
                    <span class="status-indicator status-connecting" id="connectionStatus"></span>
                    <span id="connectionText">Connecting...</span>
                </div>

                <!-- Current Session -->
                <div class="mb-3" id="currentSessionInfo" style="display: none;">
                    <small class="text-muted">Active Session:</small>
                    <div class="fw-bold" id="currentSessionId"></div>
                </div>

                <!-- New Session Button -->
                <button class="btn btn-primary w-100 mb-3" onclick="createNewSession()">
                    ‚ûï New Session
                </button>

                <!-- Recent Sessions -->
                <div id="recentSessions">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Recent Sessions</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadUserSessions()" title="Refresh">
                            üîÑ
                        </button>
                    </div>
                    <div id="sessionsList">
                        <div class="text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>ü§ñ Multi-Agent System Chat</h5>
                <div>
                    <span class="badge bg-success">{{ user.display_name }}</span>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Chat Messages Container -->
                <div class="chat-container" id="chatContainer">
                    <div class="text-center text-muted p-4" id="welcomeMessage">
                        <h5>üëã Welcome to Multi-Agent System!</h5>
                        <p>Create a new session or select an existing one to start chatting.</p>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="createNewSession()">
                                üöÄ Start New Session
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="border-top p-3" id="chatInputArea" style="display: none;">
                    <form id="chatForm" onsubmit="sendMessage(event)">
                        <div class="row g-2">
                            <div class="col">
                                <textarea class="form-control" id="messageInput" rows="2"
                                         placeholder="Ask me anything! I can solve math, write poems, explain concepts, or handle multiple requests at once..."
                                         required style="resize: none; overflow: hidden; min-height: 60px; max-height: 200px;"></textarea>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary h-100" id="sendButton">
                                    üöÄ Send
                                </button>
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="forceParallel">
                            <label class="form-check-label" for="forceParallel">
                                Force parallel processing
                            </label>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="loading-spinner mx-auto mb-3"></div>
                <h6>ü§ñ Processing your request...</h6>
                <p class="text-muted mb-0">AI agents are working in parallel</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let socket = null;
let currentSessionId = null;
let conversationHistory = [];
let isAuthenticated = false;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeSocketIO();
    // Auto-load latest session on page load
    setTimeout(() => {
        loadUserSessions(true); // true = auto-load latest session
    }, 1000); // Wait for auth to complete
});

function initializeSocketIO() {
    console.log('üîå Connecting to SocketIO server...');
    updateConnectionStatus('connecting', 'Connecting...');
    
    socket = io('{{ socketio_url }}');
    
    // Connection events
    socket.on('connect', function() {
        console.log('‚úÖ Connected to SocketIO server');
        updateConnectionStatus('connected', 'Connected');
        authenticateUser();
    });
    
    socket.on('disconnect', function() {
        console.log('‚ùå Disconnected from SocketIO server');
        updateConnectionStatus('disconnected', 'Disconnected');
        isAuthenticated = false;
    });
    
    // Authentication events
    socket.on('auth_success', function(data) {
        console.log('‚úÖ Authentication successful', data);
        isAuthenticated = true;
        updateConnectionStatus('connected', 'Connected & Authenticated');
        // Auto-load latest session after auth
        loadUserSessions(true);
    });
    
    socket.on('auth_error', function(data) {
        console.error('‚ùå Authentication failed', data);
        alert('Authentication failed: ' + data.error);
    });
    
    // Session events
    socket.on('session_created', function(data) {
        console.log('‚úÖ Session created', data);
        currentSessionId = data.session_id;
        updateCurrentSession(data);
        showChatInput();
        hideWelcomeMessage();

        // Refresh sessions list to show new session
        setTimeout(() => {
            loadUserSessions();
        }, 500);
    });
    
    socket.on('session_joined', function(data) {
        console.log('‚úÖ Session joined', data);
        currentSessionId = data.session_id;
        updateCurrentSession(data);
        showChatInput();
        hideWelcomeMessage();
        // Load session history if we have a session ID
        if (data.session_id) {
            loadSessionHistory(data.session_id);
        }
    });
    
    // Message events
    socket.on('message_response', function(data) {
        console.log('üì® Message response received', data);

        // Update current session ID if this is a new session
        if (data.session_id && !currentSessionId) {
            currentSessionId = data.session_id;
            document.getElementById('currentSessionId').textContent = data.session_id.substring(0, 8) + '...';
            document.getElementById('currentSessionInfo').style.display = 'block';

            // Refresh sessions list to show new session
            setTimeout(() => {
                loadUserSessions();
            }, 1000);
        }

        hideProcessingModal();
        addMessageToChat(data, false);
        enableChatInput();
    });
    
    socket.on('processing_error', function(data) {
        console.error('‚ùå Processing error', data);
        hideProcessingModal();
        alert('Error: ' + data.error);
        enableChatInput();
    });
    
    socket.on('error', function(data) {
        console.error('‚ùå Socket error', data);
        alert('Error: ' + data.error);
    });
}

function authenticateUser() {
    const userData = {
        user_id: '{{ user.user_id }}',
        display_name: '{{ user.display_name }}',
        email: '{{ user.email }}'
    };
    
    console.log('üîê Authenticating user...', userData);
    socket.emit('authenticate', userData);
}

function updateConnectionStatus(status, text) {
    const statusEl = document.getElementById('connectionStatus');
    const textEl = document.getElementById('connectionText');
    
    statusEl.className = `status-indicator status-${status}`;
    textEl.textContent = text;
}

function createNewSession() {
    if (!isAuthenticated) {
        alert('Please wait for authentication to complete');
        return;
    }
    
    console.log('üìù Creating new session...');
    socket.emit('create_session', {});
}

function updateCurrentSession(sessionData) {
    document.getElementById('currentSessionId').textContent = sessionData.session_id.substring(0, 8) + '...';
    document.getElementById('currentSessionInfo').style.display = 'block';
}

function showChatInput() {
    document.getElementById('chatInputArea').style.display = 'block';
    document.getElementById('messageInput').focus();
}

function hideWelcomeMessage() {
    document.getElementById('welcomeMessage').style.display = 'none';
}

function sendMessage(event) {
    event.preventDefault();
    
    if (!isAuthenticated || !currentSessionId) {
        alert('Please create a session first');
        return;
    }
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Add user message to chat immediately
    addMessageToChat({
        content: message,
        timestamp: new Date().toISOString(),
        user_input: message
    }, true);
    
    // Clear input and disable
    messageInput.value = '';
    disableChatInput();
    showProcessingModal();
    
    // Send to server
    console.log('üì§ Sending message:', message);
    socket.emit('process_message', { message: message });
}

function addMessageToChat(data, isUser) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');

    if (isUser) {
        messageDiv.className = 'message-user';
        const userContent = data.content || data.user_input;
        messageDiv.innerHTML = `
            <div class="message-content">${renderContent(userContent)}</div>
            <div class="message-timestamp">${formatTimestamp(data.timestamp)}</div>
        `;
    } else {
        messageDiv.className = 'message-assistant';
        let content = `<div class="message-content">${renderContent(data.response)}</div>`;

        // Add processing info if available
        if (data.agent_responses) {
            content += `<div class="mt-2"><small class="text-muted">Processed by ${Object.keys(data.agent_responses).length} agents</small></div>`;
        }

        content += `<div class="message-timestamp">${formatTimestamp(data.timestamp)}</div>`;
        messageDiv.innerHTML = content;

        // Render math after adding to DOM
        setTimeout(() => {
            renderMathInElement(messageDiv, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\[', right: '\\]', display: true},
                    {left: '\\(', right: '\\)', display: false}
                ]
            });
        }, 10);
    }

    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function renderContent(content) {
    if (!content) return '';

    try {
        // Configure marked for better rendering
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Parse markdown
        let rendered = marked.parse(content);

        // Handle special cases for better formatting
        rendered = rendered
            // Fix paragraph spacing
            .replace(/<p><\/p>/g, '<br>')
            // Better line breaks
            .replace(/\n\n/g, '<br><br>')
            // Clean up extra spaces
            .replace(/\s+/g, ' ');

        return rendered;
    } catch (error) {
        console.error('Error rendering content:', error);
        // Fallback to escaped HTML
        return escapeHtml(content).replace(/\n/g, '<br>');
    }
}

function showProcessingModal() {
    new bootstrap.Modal(document.getElementById('processingModal')).show();
}

function hideProcessingModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('processingModal'));
    if (modal) modal.hide();
}

function disableChatInput() {
    document.getElementById('messageInput').disabled = true;
    document.getElementById('sendButton').disabled = true;
}

function enableChatInput() {
    document.getElementById('messageInput').disabled = false;
    document.getElementById('sendButton').disabled = false;
    document.getElementById('messageInput').focus();
}

function loadUserSessions(autoLoadLatest = false) {
    fetch('/api/chat/sessions')
        .then(response => response.json())
        .then(data => {
            const sessionsList = document.getElementById('sessionsList');

            if (data.sessions && data.sessions.length > 0) {
                let sessionsHtml = '';

                // Auto-load latest session if requested and no current session
                if (autoLoadLatest && !currentSessionId && data.sessions.length > 0) {
                    const latestSession = data.sessions[0]; // Sessions are sorted by updated_at desc
                    currentSessionId = latestSession.session_id;

                    // Update UI
                    document.getElementById('currentSessionId').textContent = latestSession.session_id.substring(0, 8) + '...';
                    document.getElementById('currentSessionInfo').style.display = 'block';

                    // Load session history
                    loadSessionHistory(latestSession.session_id);

                    console.log(`üîÑ Auto-loaded latest session: ${latestSession.session_id}`);
                }

                data.sessions.forEach(session => {
                    const isActive = session.session_id === currentSessionId;
                    const activeClass = isActive ? 'active' : '';

                    sessionsHtml += `
                        <div class="session-item ${activeClass}" onclick="loadSession('${session.session_id}')">
                            <div class="session-title">
                                üí¨ ${session.session_id_display}
                            </div>
                            <div class="session-preview">
                                ${session.last_message_preview}
                            </div>
                            <div class="session-meta">
                                <span>${session.updated_at}</span>
                                <span class="session-count">${session.message_count} msgs</span>
                            </div>
                        </div>
                    `;
                });

                sessionsList.innerHTML = sessionsHtml;
            } else {
                sessionsList.innerHTML = `
                    <div class="text-muted text-center py-3">
                        <div>üìù No chat history yet</div>
                        <small>Start a conversation to see sessions here</small>
                    </div>
                `;

                // Show welcome message if no sessions
                if (autoLoadLatest) {
                    document.getElementById('chatContainer').innerHTML = `
                        <div class="text-center text-muted py-5">
                            <div class="mb-3">
                                <h4>üëã Welcome to Multi-Agent System!</h4>
                                <p>Start a conversation to see the power of parallel AI processing</p>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h6>üßÆ Math & Science</h6>
                                            <p class="small">Solve equations, explain concepts</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h6>‚úçÔ∏è Writing & Analysis</h6>
                                            <p class="small">Create content, analyze text</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Error loading sessions:', error);
            document.getElementById('sessionsList').innerHTML = `
                <div class="text-danger text-center py-3">
                    <div>‚ùå Error loading sessions</div>
                    <small>Please try again</small>
                </div>
            `;
        });
}

function loadSession(sessionId) {
    if (sessionId === currentSessionId) {
        return; // Already loaded
    }

    // Update current session
    currentSessionId = sessionId;

    // Update UI
    document.getElementById('currentSessionId').textContent = sessionId.substring(0, 8) + '...';
    document.getElementById('currentSessionInfo').style.display = 'block';

    // Load session messages
    loadSessionHistory(sessionId);

    // Update active session in sidebar
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.session-item').classList.add('active');

    // Enable chat input for continuing conversation
    enableChatInput();

    // Focus on message input
    document.getElementById('messageInput').focus();

    console.log(`üìÇ Loaded session: ${sessionId} - Ready to continue conversation`);
}

function loadSessionHistory(sessionId) {
    fetch(`/api/chat/history/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';

            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    // Add user message
                    if (msg.user_input) {
                        addMessageToChat({
                            content: msg.user_input,
                            timestamp: msg.created_at
                        }, true);
                    }

                    // Add assistant response
                    if (msg.agent_response) {
                        addMessageToChat({
                            response: msg.agent_response,
                            timestamp: msg.created_at,
                            agent_responses: msg.agent_responses
                        }, false);
                    }
                });

                // Render math in all loaded messages
                setTimeout(() => {
                    document.querySelectorAll('.message-assistant .message-content').forEach(element => {
                        renderMathInElement(element, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false},
                                {left: '\\[', right: '\\]', display: true},
                                {left: '\\(', right: '\\)', display: false}
                            ]
                        });
                    });
                }, 100);
            } else {
                chatContainer.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <div class="mb-2">üìù Empty session</div>
                        <small>No messages in this session yet</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading session history:', error);
            document.getElementById('chatContainer').innerHTML = `
                <div class="text-center text-danger py-5">
                    <div class="mb-2">‚ùå Error loading session</div>
                    <small>Please try again</small>
                </div>
            `;
        });
}

function createNewSession() {
    // Clear current chat
    document.getElementById('chatContainer').innerHTML = `
        <div class="text-center text-muted py-5">
            <div class="mb-2">üí¨ New Chat Session</div>
            <small>Start typing to begin a new conversation</small>
        </div>
    `;

    // Reset current session
    currentSessionId = null;
    document.getElementById('currentSessionInfo').style.display = 'none';

    // Remove active class from all sessions
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('active');
    });

    // Emit create_session event to server
    if (socket && socket.connected) {
        console.log('üìù Creating new session...');
        socket.emit('create_session', {});
    }

    // Focus on input
    document.getElementById('messageInput').focus();

    console.log('üÜï Created new session');
}

function formatTimestamp(timestamp) {
    try {
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
    } catch (e) {
        return timestamp;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle Enter key in textarea and auto-resize
const messageInput = document.getElementById('messageInput');

messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(e);
    }
});

// Auto-resize textarea
function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    const newHeight = Math.min(Math.max(textarea.scrollHeight, 60), 200);
    textarea.style.height = newHeight + 'px';
}

messageInput.addEventListener('input', function() {
    autoResizeTextarea(this);
});

// Initialize auto-resize
autoResizeTextarea(messageInput);
</script>
{% endblock %}
