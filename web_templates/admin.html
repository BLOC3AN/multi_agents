{% extends "base.html" %}

{% block title %}Admin Dashboard - Multi-Agent System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>‚öôÔ∏è Admin Dashboard</h1>
        <p class="text-muted">System monitoring and management</p>
        <hr>
    </div>
</div>

<!-- Metrics Overview -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="admin-metric">
            <h3 id="totalUsers">-</h3>
            <p>Total Users</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="admin-metric">
            <h3 id="activeSessions">-</h3>
            <p>Active Sessions</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="admin-metric">
            <h3 id="totalMessages">-</h3>
            <p>Total Messages</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="admin-metric">
            <h3 id="systemHealth">-</h3>
            <p>System Health</p>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" 
                type="button" role="tab">üìä Overview</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" 
                type="button" role="tab">üë• Users</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" 
                type="button" role="tab">üí¨ Sessions</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" 
                type="button" role="tab">üìù Messages</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" 
                type="button" role="tab">üìã Logs</button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content mt-4" id="adminTabContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìà System Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div id="systemStats">
                            <div class="d-flex justify-content-center">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üîß System Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="systemStatus">
                            <div class="d-flex justify-content-center">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-pane fade" id="users" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>üë• User Management</h5>
                <div>
                    <button class="btn btn-success btn-sm me-2" onclick="showAddUserModal()">
                        ‚ûï Add Member
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="refreshUsers()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="usersTable">
                    <div class="d-flex justify-content-center">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sessions Tab -->
    <div class="tab-pane fade" id="sessions" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>üí¨ Session Management</h5>
                <button class="btn btn-primary btn-sm" onclick="refreshSessions()">
                    üîÑ Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="sessionsTable">
                    <div class="d-flex justify-content-center">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Tab -->
    <div class="tab-pane fade" id="messages" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>üìù Message Analysis</h5>
                <button class="btn btn-primary btn-sm" onclick="refreshMessages()">
                    üîÑ Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="messagesTable">
                    <div class="d-flex justify-content-center">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Tab -->
    <div class="tab-pane fade" id="logs" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>üìã System Logs</h5>
                <div>
                    <button class="btn btn-primary btn-sm" onclick="refreshLogs()">
                        üîÑ Refresh
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearLogs()">
                        üóëÔ∏è Clear
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="logsContainer">
                    <div class="d-flex justify-content-center">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Initialize admin dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    
    // Set up tab change handlers
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const target = e.target.getAttribute('data-bs-target');
            loadTabData(target);
        });
    });
});

function loadDashboardData() {
    console.log('üìä Loading admin dashboard data...');
    
    // Load overview metrics
    loadMetrics();
    loadSystemStats();
}

function loadMetrics() {
    // Load real metrics from API
    fetch('/api/admin/metrics')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('activeSessions').textContent = data.active_sessions;
            document.getElementById('totalMessages').textContent = data.total_messages.toLocaleString();
            document.getElementById('systemHealth').textContent = data.system_health;
        })
        .catch(error => {
            console.error('Error loading metrics:', error);
            document.getElementById('totalUsers').textContent = 'Error';
            document.getElementById('activeSessions').textContent = 'Error';
            document.getElementById('totalMessages').textContent = 'Error';
            document.getElementById('systemHealth').textContent = 'Error';
        });
}

function loadSystemStats() {
    const statsHtml = `
        <div class="row g-3">
            <div class="col-6">
                <div class="border rounded p-3 text-center">
                    <h6>CPU Usage</h6>
                    <div class="progress">
                        <div class="progress-bar" style="width: 45%">45%</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="border rounded p-3 text-center">
                    <h6>Memory Usage</h6>
                    <div class="progress">
                        <div class="progress-bar bg-warning" style="width: 68%">68%</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="border rounded p-3 text-center">
                    <h6>Disk Usage</h6>
                    <div class="progress">
                        <div class="progress-bar bg-info" style="width: 32%">32%</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="border rounded p-3 text-center">
                    <h6>Network I/O</h6>
                    <div class="progress">
                        <div class="progress-bar bg-success" style="width: 23%">23%</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        document.getElementById('systemStats').innerHTML = statsHtml;
    }, 1200);
    
    const statusHtml = `
        <div class="list-group list-group-flush">
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>üîå SocketIO Server</span>
                <span class="badge bg-success">Online</span>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>üóÑÔ∏è MongoDB</span>
                <span class="badge bg-success">Connected</span>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>üî¥ Redis Cache</span>
                <span class="badge bg-success">Active</span>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>ü§ñ Agent System</span>
                <span class="badge bg-success">Ready</span>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        document.getElementById('systemStatus').innerHTML = statusHtml;
    }, 1500);
}

function loadTabData(target) {
    // Stop auto-refresh when switching tabs
    stopLogsAutoRefresh();

    switch(target) {
        case '#users':
            loadUsersData();
            break;
        case '#sessions':
            loadSessionsData();
            break;
        case '#messages':
            loadMessagesData();
            break;
        case '#logs':
            loadLogsData();
            startLogsAutoRefresh(); // Start auto-refresh for logs
            break;
    }
}

function loadUsersData() {
    fetch('/api/admin/users')
        .then(response => response.json())
        .then(data => {
            let usersHtml = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Display Name</th>
                                <th>Email</th>
                                <th>Password</th>
                                <th>Password Hash</th>
                                <th>Created</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (data.users && data.users.length > 0) {
                data.users.forEach(user => {
                    const statusBadge = user.is_active ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>';

                    usersHtml += `
                        <tr>
                            <td>${user.user_id}</td>
                            <td>${user.display_name || 'N/A'}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td><span class="badge bg-info">${user.password}</span></td>
                            <td><code class="text-muted">${user.password_hash}</code></td>
                            <td>${user.created_at}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewUser('${user.user_id}')">View</button>
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="changePassword('${user.user_id}')">Change Pass</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.user_id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                usersHtml += `
                    <tr>
                        <td colspan="8" class="text-center text-muted">No users found</td>
                    </tr>
                `;
            }

            usersHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('usersTable').innerHTML = usersHtml;
        })
        .catch(error => {
            console.error('Error loading users:', error);
            document.getElementById('usersTable').innerHTML = `
                <div class="alert alert-danger">Error loading users: ${error.message}</div>
            `;
        });
}

function loadSessionsData() {
    fetch('/api/admin/sessions')
        .then(response => response.json())
        .then(data => {
            let sessionsHtml = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>User</th>
                                <th>Messages</th>
                                <th>Created</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (data.sessions && data.sessions.length > 0) {
                data.sessions.forEach(session => {
                    const statusBadge = session.is_active ?
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Inactive</span>';

                    sessionsHtml += `
                        <tr>
                            <td>${session.session_id_display || session.session_id}</td>
                            <td>${session.user_id}</td>
                            <td>${session.total_messages}</td>
                            <td>${session.created_at}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewSession('${session.session_id}')">View</button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                sessionsHtml += `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No sessions found</td>
                    </tr>
                `;
            }

            sessionsHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('sessionsTable').innerHTML = sessionsHtml;
        })
        .catch(error => {
            console.error('Error loading sessions:', error);
            document.getElementById('sessionsTable').innerHTML = `
                <div class="alert alert-danger">Error loading sessions: ${error.message}</div>
            `;
        });
}

function loadMessagesData() {
    fetch('/api/admin/messages')
        .then(response => response.json())
        .then(data => {
            const stats = data.stats || {};
            const messages = data.recent_messages || [];

            let messagesHtml = `
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>${stats.total_messages || 0}</h5>
                                <small>Total Messages</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>${stats.successful_messages || 0}</h5>
                                <small>Successful</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>${stats.failed_messages || 0}</h5>
                                <small>Failed</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5>${stats.avg_response_time || 'N/A'}</h5>
                                <small>Avg Response</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Message ID</th>
                                <th>User</th>
                                <th>Content</th>
                                <th>Response Time</th>
                                <th>Status</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (messages.length > 0) {
                messages.forEach(msg => {
                    const statusBadge = msg.success ?
                        '<span class="badge bg-success">Success</span>' :
                        '<span class="badge bg-danger">Failed</span>';

                    messagesHtml += `
                        <tr>
                            <td>${msg.message_id}</td>
                            <td>${msg.user_id}</td>
                            <td>${msg.content}</td>
                            <td>${msg.processing_time}</td>
                            <td>${statusBadge}</td>
                            <td>${msg.created_at}</td>
                        </tr>
                    `;
                });
            } else {
                messagesHtml += `
                    <tr>
                        <td colspan="6" class="text-center text-muted">No messages found</td>
                    </tr>
                `;
            }

            messagesHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('messagesTable').innerHTML = messagesHtml;
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            document.getElementById('messagesTable').innerHTML = `
                <div class="alert alert-danger">Error loading messages: ${error.message}</div>
            `;
        });
}

function loadLogsData() {
    fetch('/api/admin/logs')
        .then(response => response.json())
        .then(data => {
            const logs = data.logs || [];

            let logsHtml = `
                <div class="bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
            `;

            if (logs.length > 0) {
                logs.forEach(log => {
                    const levelColor = {
                        'ERROR': 'text-danger',
                        'WARNING': 'text-warning',
                        'INFO': 'text-info',
                        'DEBUG': 'text-muted'
                    }[log.level] || 'text-light';

                    const cleanMessage = log.message.replace(log.timestamp, '').replace(`[${log.level}]`, '').trim();

                    logsHtml += `
                        <div class="mb-1">
                            <span class="text-muted">${log.timestamp}</span>
                            <span class="badge bg-secondary">${log.source}</span>
                            <span class="${levelColor}">[${log.level}]</span>
                            <span>${log.icon}</span>
                            <span class="log-content">${cleanMessage}</span>
                        </div>
                    `;
                });
            } else {
                logsHtml += `
                    <div class="text-center text-muted">
                        <p>No logs available</p>
                        <small>Logs will appear here as the system operates</small>
                    </div>
                `;
            }

            logsHtml += `</div>`;

            document.getElementById('logsContainer').innerHTML = logsHtml;

            // Auto-scroll to bottom
            const container = document.querySelector('#logsContainer .bg-dark');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        })
        .catch(error => {
            console.error('Error loading logs:', error);
            document.getElementById('logsContainer').innerHTML = `
                <div class="alert alert-danger">Error loading logs: ${error.message}</div>
            `;
        });
}

function refreshUsers() {
    document.getElementById('usersTable').innerHTML = '<div class="d-flex justify-content-center"><div class="loading-spinner"></div></div>';
    loadUsersData();
}

function refreshSessions() {
    document.getElementById('sessionsTable').innerHTML = '<div class="d-flex justify-content-center"><div class="loading-spinner"></div></div>';
    loadSessionsData();
}

function refreshMessages() {
    document.getElementById('messagesTable').innerHTML = '<div class="d-flex justify-content-center"><div class="loading-spinner"></div></div>';
    loadMessagesData();
}

function refreshLogs() {
    document.getElementById('logsContainer').innerHTML = '<div class="d-flex justify-content-center"><div class="loading-spinner"></div></div>';
    loadLogsData();
}

// Auto-refresh logs every 10 seconds when logs tab is active
let logsAutoRefresh = null;

function startLogsAutoRefresh() {
    if (logsAutoRefresh) clearInterval(logsAutoRefresh);
    logsAutoRefresh = setInterval(() => {
        // Only refresh if logs tab is active
        const logsTab = document.getElementById('logs-tab');
        if (logsTab && logsTab.classList.contains('active')) {
            loadLogsData();
        }
    }, 10000); // 10 seconds
}

function stopLogsAutoRefresh() {
    if (logsAutoRefresh) {
        clearInterval(logsAutoRefresh);
        logsAutoRefresh = null;
    }
}

function clearLogs() {
    if (confirm('Are you sure you want to clear all logs?')) {
        fetch('/api/admin/logs/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('logsContainer').innerHTML = `
                    <div class="bg-dark text-light p-3 rounded text-center" style="height: 400px; display: flex; align-items: center; justify-content: center;">
                        <div>
                            <div class="text-success mb-2">‚úÖ Logs cleared successfully</div>
                            <small class="text-muted">Cleared ${data.files ? data.files.length : 0} log files</small>
                        </div>
                    </div>
                `;

                // Reload logs after 2 seconds to show the "Logs cleared" entry
                setTimeout(() => {
                    loadLogsData();
                }, 2000);
            } else {
                alert('Failed to clear logs: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error clearing logs:', error);
            alert('Error clearing logs: ' + error.message);
        });
    }
}

// View functions
function viewUser(userId) {
    fetch(`/api/admin/users`)
        .then(response => response.json())
        .then(data => {
            const user = data.users.find(u => u.user_id === userId);
            if (user) {
                showUserModal(user);
            }
        })
        .catch(error => console.error('Error:', error));
}

function showUserModal(user) {
    const modalHtml = `
        <div class="modal fade" id="userModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üë§ User Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">User ID:</label>
                                <p class="form-control-plaintext">${user.user_id}</p>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Display Name:</label>
                                <p class="form-control-plaintext">${user.display_name || 'N/A'}</p>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Email:</label>
                                <p class="form-control-plaintext">${user.email || 'N/A'}</p>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Password:</label>
                                <p class="form-control-plaintext"><span class="badge bg-info">${user.password}</span></p>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Password Hash:</label>
                                <p class="form-control-plaintext"><code class="text-muted">${user.password_hash}</code></p>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Created:</label>
                                <p class="form-control-plaintext">${user.created_at}</p>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Status:</label>
                                <p class="form-control-plaintext">
                                    <span class="badge ${user.is_active ? 'bg-success' : 'bg-secondary'}">
                                        ${user.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal
    const existingModal = document.getElementById('userModal');
    if (existingModal) existingModal.remove();

    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    new bootstrap.Modal(document.getElementById('userModal')).show();
}

function viewSession(sessionId) {
    fetch(`/api/admin/session/${sessionId}`)
        .then(response => response.json())
        .then(sessionData => {
            console.log('Session data received:', sessionData); // Debug log
            showSessionModal(sessionData, sessionData.messages || []);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load session details');
        });
}

function showSessionModal(session, messages) {
    // Ensure messages is an array
    const messagesList = Array.isArray(messages) ? messages : [];

    const messagesHtml = messagesList.length > 0 ?
        messagesList.map(msg => `
            <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong>üí¨ Message</strong>
                    <small class="text-muted">${msg.created_at}</small>
                </div>
                <div class="mb-2">
                    <strong>User:</strong>
                    <p class="mb-1 ms-3">${msg.user_input}</p>
                </div>
                <div class="mb-2">
                    <strong>Assistant:</strong>
                    <p class="mb-1 ms-3">${msg.agent_response.substring(0, 200)}${msg.agent_response.length > 200 ? '...' : ''}</p>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="badge ${msg.success ? 'bg-success' : 'bg-danger'}">${msg.success ? 'Success' : 'Failed'}</span>
                    <small>‚è±Ô∏è ${msg.processing_time}</small>
                </div>
            </div>
        `).join('') :
        '<p class="text-muted">No messages in this session</p>';

    const modalHtml = `
        <div class="modal fade" id="sessionModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üí¨ Session Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Session ID:</label>
                                <p class="form-control-plaintext">${session.session_id}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">User:</label>
                                <p class="form-control-plaintext">${session.user_id}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Created:</label>
                                <p class="form-control-plaintext">${session.created_at}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Total Messages:</label>
                                <p class="form-control-plaintext">${session.total_messages}</p>
                            </div>
                        </div>
                        <h6>üìù Recent Messages:</h6>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${messagesHtml}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal
    const existingModal = document.getElementById('sessionModal');
    if (existingModal) existingModal.remove();

    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    new bootstrap.Modal(document.getElementById('sessionModal')).show();
}

// Add User Modal
function showAddUserModal() {
    const modalHtml = `
        <div class="modal fade" id="addUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">‚ûï Add New Member</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="addUserForm" onsubmit="addUser(event)">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="newUserId" class="form-label">User ID *</label>
                                <input type="text" class="form-control" id="newUserId" required
                                       pattern="[a-zA-Z0-9._-]+" minlength="3" maxlength="50"
                                       placeholder="Enter unique user ID">
                                <div class="form-text">3-50 characters, letters, numbers, dots, underscores, hyphens only</div>
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">Password *</label>
                                <input type="password" class="form-control" id="newPassword" required
                                       minlength="6" placeholder="Enter password">
                                <div class="form-text">At least 6 characters</div>
                            </div>
                            <div class="mb-3">
                                <label for="newDisplayName" class="form-label">Display Name</label>
                                <input type="text" class="form-control" id="newDisplayName"
                                       placeholder="How the user will be displayed">
                            </div>
                            <div class="mb-3">
                                <label for="newEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="newEmail"
                                       placeholder="user@example.com">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="newUserActive" checked>
                                    <label class="form-check-label" for="newUserActive">
                                        Active user
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">
                                <span class="spinner-border spinner-border-sm d-none" id="addUserSpinner"></span>
                                ‚ûï Add Member
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal
    const existingModal = document.getElementById('addUserModal');
    if (existingModal) existingModal.remove();

    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    new bootstrap.Modal(document.getElementById('addUserModal')).show();
}

function addUser(event) {
    event.preventDefault();

    const submitBtn = event.target.querySelector('button[type="submit"]');
    const spinner = document.getElementById('addUserSpinner');

    // Show loading
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');

    const userData = {
        user_id: document.getElementById('newUserId').value.trim(),
        password: document.getElementById('newPassword').value.trim(),
        display_name: document.getElementById('newDisplayName').value.trim(),
        email: document.getElementById('newEmail').value.trim(),
        is_active: document.getElementById('newUserActive').checked
    };

    fetch('/api/admin/users', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();

            // Show success message
            showToast('‚úÖ Member added successfully!', 'success');

            // Refresh users list
            refreshUsers();
        } else {
            throw new Error(data.message || 'Failed to add user');
        }
    })
    .catch(error => {
        console.error('Error adding user:', error);
        showToast('‚ùå Error: ' + error.message, 'danger');
    })
    .finally(() => {
        // Hide loading
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
    });
}

function deleteUser(userId) {
    if (confirm(`Are you sure you want to delete user "${userId}"?\n\nThis action cannot be undone.`)) {
        fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('‚úÖ User deleted successfully!', 'success');
                refreshUsers();
            } else {
                throw new Error(data.message || 'Failed to delete user');
            }
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            showToast('‚ùå Error: ' + error.message, 'danger');
        });
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    // Add toast
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

    // Show toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
    toast.show();

    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function changePassword(userId) {
    const modalHtml = `
        <div class="modal fade" id="changePasswordModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üîê Change Password</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="changePasswordForm" onsubmit="updatePassword(event, '${userId}')">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">User:</label>
                                <p class="form-control-plaintext">${userId}</p>
                            </div>
                            <div class="mb-3">
                                <label for="newPasswordInput" class="form-label">New Password *</label>
                                <input type="password" class="form-control" id="newPasswordInput" required
                                       minlength="6" placeholder="Enter new password">
                                <div class="form-text">At least 6 characters</div>
                            </div>
                            <div class="mb-3">
                                <label for="confirmPasswordInput" class="form-label">Confirm Password *</label>
                                <input type="password" class="form-control" id="confirmPasswordInput" required
                                       minlength="6" placeholder="Confirm new password">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">
                                <span class="spinner-border spinner-border-sm d-none" id="changePasswordSpinner"></span>
                                üîê Update Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal
    const existingModal = document.getElementById('changePasswordModal');
    if (existingModal) existingModal.remove();

    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
}

function updatePassword(event, userId) {
    event.preventDefault();

    const newPassword = document.getElementById('newPasswordInput').value.trim();
    const confirmPassword = document.getElementById('confirmPasswordInput').value.trim();

    // Validate passwords match
    if (newPassword !== confirmPassword) {
        showToast('‚ùå Passwords do not match', 'danger');
        return;
    }

    const submitBtn = event.target.querySelector('button[type="submit"]');
    const spinner = document.getElementById('changePasswordSpinner');

    // Show loading
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');

    fetch(`/api/admin/users/${userId}/password`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ password: newPassword })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();

            // Show success message
            showToast('‚úÖ Password updated successfully!', 'success');

            // Refresh users list
            refreshUsers();
        } else {
            throw new Error(data.message || 'Failed to update password');
        }
    })
    .catch(error => {
        console.error('Error updating password:', error);
        showToast('‚ùå Error: ' + error.message, 'danger');
    })
    .finally(() => {
        // Hide loading
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
    });
}
</script>
{% endblock %}
